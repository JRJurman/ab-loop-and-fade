<!DOCTYPE html>
<html lang="en">
	<head>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
			rel="stylesheet"
		/>

		<title>A-B Loop and Crossfade</title>
		<style>
			/* Kanit font - https://fonts.google.com/specimen/Kanit */
			:root,
			button {
				font-family: 'Kanit', sans-serif;
			}

			body {
				margin: 0;
			}

			button {
				text-decoration: underline;
				cursor: pointer;
				background: none;
				color: currentColor;
				border: none;
				font-size: 1em;
				font-weight: inherit;
				padding: 0;
			}

			a {
				color: currentColor;
			}

			/* Unfretted Color Scheme - https://colors.lol/unfretted */
			:root {
				--foreground-color: #ffd8b1;
				--background-color: #610023;
				color: var(--foreground-color);
				background: var(--background-color);
				accent-color: var(--foreground-color);
			}

			dialog {
				color: white;
				background: var(--background-color);

				h2,
				button {
					color: var(--foreground-color);
				}
			}

			main {
				display: flex;
				flex-direction: column;
				width: 100%;
				gap: 1em;

				max-width: 500px;
				margin: auto;
			}

			h1 {
				font-weight: 400;
				border-bottom: solid 1px currentColor;
				margin: 0 0 0.5em 0;
				padding: 0.5em 0em;
				text-align: center;
			}

			fieldset {
				display: flex;
				flex-direction: column;
				gap: 0.25em;
				border-radius: 20px;
				border-color: currentColor;
				border-style: solid;
			}

			audio {
				width: 100%;
			}

			label {
				display: flex;
				align-items: center;
				gap: 0.2em;
			}

			input[type='range'] {
				flex: 1;
			}

			footer {
				position: absolute;
				bottom: 0;
				width: 100%;
				text-align: center;
				background: oklch(from var(--background-color) 0.2 c h);
			}

			dialog {
				font-size: 0.8em;
				max-width: 600px;
				color: white;
			}

			ol {
				padding-left: 1em;
			}
		</style>
	</head>
	<body>
		<h1>A-B Loop And Crossfade</h1>
		<main>
			<label>
				Master Volume
				<input id="masterVolume" type="range" min="0" max="100" step="1" value="100" />
				<output id="masterVolumeOutput">100</output>
			</label>
			<input id="file" type="file" accept="audio/*" />
			<fieldset>
				<legend>Tracks</legend>
				<audio id="audio1" controls></audio>
				<label>
					Volume <input id="track1Volume" type="range" min="0" max="1" step="any" value="1" disabled />
					<output id="track1VolumeOutput">1.000</output>
				</label>
				<audio id="audio2" controls></audio>
				<label>
					Volume <input id="track2Volume" type="range" min="0" max="1" step="any" value="1" disabled />
					<output id="track2VolumeOutput">1.000</output>
				</label>
			</fieldset>
			<fieldset>
				<legend>Controls</legend>
				<label>
					Point A
					<input id="pointA" type="range" min="0" max="100" step="1" value="10" />
					<output id="pointAOutput">0:10</output>
				</label>
				<label>
					Point B
					<input id="pointB" type="range" min="0" max="100" step="1" value="90" />
					<output id="pointBOutput">1:30</output>
				</label>
				<label>
					Passthrough
					<input id="passthrough" type="checkbox" />
				</label>
				<label>
					Crossfade
					<input id="crossfade" type="range" min="0" max="5000" step="100" value="1500" />
					<output id="crossfadeOutput">1500 ms</output>
				</label>
			</fieldset>
		</main>
		<footer>
			Created by <a href="https://jrjurman.com">Jesse Jurman</a>.
			<button id="aboutButton" commandfor="aboutDialog" command="show-modal">About / How to Use</button>.
		</footer>
		<dialog id="aboutDialog" closedby="any">
			<h2>What is A-B Loop and Crossfade?</h2>
			<p>
				This web application is a tool for quickly creating background loops with tracks that might otherwise have a
				natural fade at the start and end of the track.
			</p>
			<p style="font-style: italic">This application collects no data and runs entirely local to your computer.</p>
			<h2>How do I use this?</h2>
			<ol>
				<li>Select an audio file you have access to on your computer.</li>
				<li>Drag the Point A and Point B sliders to the start and end of where you want the loop to be.</li>
				<li>Hit the play button on either of track players!</li>
			</ol>
			<p>
				After doing the above, you should hear the track play. Once the player reaches your "Point B" timestamp, it will
				start to fade the current track and start up the track on the second player, starting at your "Point A"
				timestamp. This will repeat between both players until you pause, or enable "Passthrough".
			</p>
			<h2>What are these controls?</h2>
			<p>
				<strong>Master Volume - </strong>
				Since each track needs to dynamically change its volume up and down, we have a master control at the top so you
				can set the max volume of both at once.
			</p>
			<p>
				<strong>Point A and Point B - </strong>
				The start and end of your loop. When one of the players hits "Point B", the other player will start playing at
				"Point A".
			</p>
			<p>
				<strong>Passthrough - </strong>
				If this is enabled, we will stop looping, and allow the player to continue to the end. This is useful if you
				want the track to naturally stop.
			</p>
			<p>
				<strong>Crossfade - </strong>
				How long you want both of the tracks to be playing on top of each other. A longer crossfade can make the
				transition feel more seamless.
			</p>
			<button id="closeButton" commandfor="aboutDialog" command="close">Start Looping!</button>
		</dialog>
		<script>
			// dialog wiring (ideally this would be handled by commandfor, but support is not universal yet)
			aboutButton.addEventListener('click', () => {
				aboutDialog.showModal();
			});
			closeButton.addEventListener('click', () => {
				aboutDialog.close();
			});
		</script>
		<script>
			// wire passthrough handler
			const onPassthroughChange = () => {
				pointB.disabled = passthrough.checked;
			};
			passthrough.addEventListener('change', onPassthroughChange);

			// wire master volume control
			const onMasterVolumeChange = () => {
				masterVolumeOutput.value = masterVolume.value;
				audio1.volume = masterVolume.value / 100;
				audio2.volume = masterVolume.value / 100;
			};
			masterVolume.addEventListener('input', onMasterVolumeChange);

			// wire track volume controls
			const onVolumeChange = (audioElement, trackInput, trackOutput) => {
				trackInput.value = audioElement.volume;
				trackOutput.value = audioElement.volume.toFixed(3);
			};
			audio1.addEventListener('volumechange', () => onVolumeChange(audio1, track1Volume, track1VolumeOutput));
			audio2.addEventListener('volumechange', () => onVolumeChange(audio2, track2Volume, track2VolumeOutput));

			// wire point A and B range controls
			const onUpdateRangeOutput = (rangeInput, rangeOutput) => {
				const rawSeconds = rangeInput.value % 60;
				const seconds = rawSeconds < 10 ? `0${rawSeconds}` : rawSeconds;
				const minutes = Math.floor(rangeInput.value / 60);
				rangeOutput.value = `${minutes}:${seconds}`;
			};
			pointA.addEventListener('input', () => onUpdateRangeOutput(pointA, pointAOutput));
			pointB.addEventListener('input', () => onUpdateRangeOutput(pointB, pointBOutput));

			// wire crossfade range control
			const onUpdateCrossfade = () => {
				crossfadeOutput.value = `${crossfade.value} ms`;
			};
			crossfade.addEventListener('input', onUpdateCrossfade);

			// wire file loading control
			file.addEventListener('change', () => {
				const url = URL.createObjectURL(file.files[0]);
				audio1.src = url;
				audio2.src = url;
				audio1.onloadedmetadata = () => {
					const duration = audio1.duration || 100;
					pointA.max = duration;
					pointB.max = duration;
				};
			});
		</script>
		<script>
			// logic for triggering and processing the A-B loop and crossfade

			const intervalMS = 10;
			const startCrossfade = (fromAudioElement, toAudioElement) => {
				// set data attributes (so we can style and determine which elements are which)
				fromAudioElement.setAttribute('data-crossfade', 'from');
				toAudioElement.setAttribute('data-crossfade', 'to');

				// setup our toAudioElement
				toAudioElement.volume = 0;
				toAudioElement.currentTime = pointA.value;
				toAudioElement.play();

				// fixed interval of 10 ms
				window.crossfadeIntervalId = setInterval(stepCrossfade, intervalMS);
			};

			const stepCrossfade = () => {
				const fromAudioElement = document.querySelector('[data-crossfade="from"]');
				const toAudioElement = document.querySelector('[data-crossfade="to"]');

				// if we've finished, clear the interval
				const masterVolumeAudioValue = masterVolume.value / 100;
				if (toAudioElement.volume >= masterVolumeAudioValue) {
					clearInterval(window.crossfadeIntervalId);
					fromAudioElement.pause();
					fromAudioElement.removeAttribute('data-crossfade');
					toAudioElement.removeAttribute('data-crossfade');
				}

				// change the volume based on our intervalMS and crossfade value
				const volumeIncrement = intervalMS / crossfade.value;
				fromAudioElement.volume = Math.max(fromAudioElement.volume - volumeIncrement, 0);
				toAudioElement.volume = Math.min(toAudioElement.volume + volumeIncrement, 1);
			};

			const onTimeUpdate = (audioElement, otherAudioElement) => {
				// if we're already crossfading, do nothing
				const fromAudioElement = document.querySelector('[data-crossfade="from"]');
				const toAudioElement = document.querySelector('[data-crossfade="to"]');
				if (fromAudioElement || toAudioElement) {
					return;
				}
				// if the element is paused, do nothing
				if (audioElement.paused) {
					return;
				}
				// if passthrough is enabled, do nothing
				if (passthrough.checked) {
					return;
				}
				// if we've hit the end (point B), start the other audio element
				if (audioElement.currentTime >= pointB.value) {
					startCrossfade(audioElement, otherAudioElement);
				}
			};

			audio1.addEventListener('timeupdate', () => onTimeUpdate(audio1, audio2));
			audio2.addEventListener('timeupdate', () => onTimeUpdate(audio2, audio1));
		</script>
	</body>
</html>
