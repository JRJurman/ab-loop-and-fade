<!DOCTYPE html>
<html lang="en">
	<head>
		<title>A-B Loop and Crossfade</title>

		<!-- support unicode characters -->
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

		<!-- Social Tags-->
		<meta property="og:title" content="A-B Loop and Crossfade" />
		<meta property="og:url" content="https://jrjurman.com/ab-loop-and-fade/" />
		<meta property="og:image" content="https://jrjurman.com/ab-loop-and-fade/preview.png" />

		<!-- font -->
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
			rel="stylesheet"
		/>

		<!-- components -->
		<script src="./scripts/saveABConfig.js"></script>
		<script src="./components/ab-audio-block.js"></script>
		<script src="./components/ab-track-select.js"></script>
		<script src="./components/ab-range-input.js"></script>
		<script src="./components/ab-tracks.js"></script>
		<script src="./components/ab-controls.js"></script>
		<script src="./components/writable-header.js"></script>

		<link rel="icon" href="./favicon.png" />

		<style>
			/* Kanit font - https://fonts.google.com/specimen/Kanit */
			:root,
			button {
				font-family: 'Kanit', sans-serif;
			}

			body {
				margin: 0;

				display: grid;
				grid-template-rows: auto 1fr auto;
				grid-template-areas:
					'header'
					'content'
					'footer';
				height: 100vh;

				header {
					grid-area: header;
				}

				main {
					grid-area: content;
					overflow-y: auto;
					height: 100%;
				}

				footer {
					grid-area: footer;
					position: sticky;
					bottom: 0;
				}
			}

			button {
				text-decoration: underline;
				cursor: pointer;
				background: none;
				color: currentColor;
				border: none;
				font-size: 1em;
				font-weight: inherit;
				padding: 0;
			}

			a {
				color: currentColor;
			}

			/* Unfretted Color Scheme - https://colors.lol/unfretted */
			:root {
				--foreground-color: #ffd8b1;
				--background-color: #610023;
				color: var(--foreground-color);
				background: var(--background-color);
				accent-color: var(--foreground-color);
			}

			dialog {
				color: white;
				background: var(--background-color);

				h2,
				button {
					color: var(--foreground-color);
				}
			}

			main,
			audio-blocks {
				display: flex;
				flex-direction: column;
				gap: 1em;
			}

			main {
				* {
					width: 100%;
					max-width: 500px;
					margin: 0 auto;
				}

				button {
					margin: 1em auto;
				}
			}

			h1 {
				font-weight: 400;
				border-bottom: solid 1px currentColor;
				margin: 0 0 0.5em 0;
				padding: 0.5em 0em;
				text-align: center;
			}

			footer {
				width: 100%;
				text-align: center;
				background: oklch(from var(--background-color) 0.2 c h);
			}

			dialog {
				font-size: 0.8em;
				max-width: 600px;
			}

			dialog section {
				display: flex;
				flex-direction: column;
				gap: 1em;

				* {
					margin: 0;
				}

				button {
					order: 1;
				}
			}

			ol {
				padding-left: 1em;
			}

			ab-top-controls {
				display: flex;
				flex-direction: column;
				gap: 0.2em;
			}
		</style>
	</head>
	<body>
		<header>
			<writable-header id="pageTitle">
				<h1>A-B Loop And Crossfade</h1>
			</writable-header>
		</header>
		<footer>
			Created by <a href="https://jrjurman.com">Jesse Jurman</a>.
			<button id="aboutButton" type="button" commandfor="aboutDialog" command="show-modal">About / How to Use</button>.
		</footer>
		<main>
			<ab-top-controls>
				<ab-range-input id="masterVolume" min="0" max="100" step="1" value="100">Master Volume</ab-range-input>
				<ab-track-select id="playingSelect" label="Source" action="Play Source"></ab-track-select>
				<ab-track-select id="transitionSelect" label="Destination" action="Crossfade Tracks"></ab-track-select>
			</ab-top-controls>
			<audio-blocks id="audioBlocks">
				<ab-audio-block></ab-audio-block>
			</audio-blocks>
			<button id="addTrackButton" type="button">Add Track</button>
		</main>
		<dialog id="aboutDialog" closedby="any">
			<section>
				<button id="closeButton" type="button" commandfor="aboutDialog" command="close">Start Looping!</button>
				<h2>What is A-B Loop and Crossfade?</h2>
				<p>
					This web application is a tool for quickly creating background loops with tracks that might otherwise have a
					natural fade at the start and end of the track.
				</p>
				<p style="font-style: italic">This application collects no data and runs entirely local to your computer.</p>
				<h2>How do I use this?</h2>
				<ol>
					<li>Select an audio file you have access to on your computer.</li>
					<li>Drag the Point A and Point B sliders to the start and end of where you want the loop to be.</li>
					<li>Hit the play button on either of track players!</li>
				</ol>
				<p>
					After doing the above, you should hear the track play. Once the player reaches your "Point B" timestamp, it
					will start to fade the current track and start up the track on the second player, starting at your "Point A"
					timestamp. This will repeat between both players until you pause, or enable "Passthrough".
				</p>
				<h2>What are these controls?</h2>
				<p>
					<strong>Master Volume - </strong>
					Since each track needs to dynamically change its volume up and down, we have a master control at the top so
					you can set the max volume of both at once.
				</p>
				<p>
					<strong>Point A and Point B - </strong>
					The start and end of your loop. When one of the players hits "Point B", the other player will start playing at
					"Point A".
				</p>
				<p>
					<strong>Passthrough - </strong>
					If this is enabled, we will stop looping, and allow the player to continue to the end. This is useful if you
					want the track to naturally stop.
				</p>
				<p>
					<strong>Crossfade - </strong>
					How long you want both of the tracks to be playing on top of each other. A longer crossfade can make the
					transition feel more seamless.
				</p>
				<p>
					<strong>Export - </strong>
					This saves an <code>.abconfig</code> file on your computer that is a combination of the above configurations
					and the audio file, so you can quickly load saved configurations later.
				</p>
			</section>
		</dialog>
		<script>
			// dialog wiring (ideally this would be handled by commandfor, but support is not universal yet)
			aboutButton.addEventListener('click', () => {
				aboutDialog.showModal();
			});
			closeButton.addEventListener('click', () => {
				aboutDialog.close();
			});
		</script>
		<script>
			// wire master volume control
			const onMasterVolumeChange = () => {
				[...audioBlocks.children].forEach((audioBlock) => {
					audioBlock.audioTracks.setMasterVolume(masterVolume.value / 100);
				});
			};
			masterVolume.addEventListener('input', onMasterVolumeChange);

			const firstAudioBlock = audioBlocks.firstElementChild;

			// wire file loading control for setting document title
			firstAudioBlock.addEventListener('load-track', () => {
				// if pageTitle is the default, and there is only one audio block, set it to the track name
				if (pageTitle.isDefault() && audioBlocks.children.length === 1) {
					document.title = firstAudioBlock.fileName;
					pageTitle.titleFallback = firstAudioBlock.fileName;
				}
			});

			// wire adding this option to the play and transition selects
			playingSelect.addTrackOption(firstAudioBlock, true);
			transitionSelect.addTrackOption(firstAudioBlock, true);

			// wire control for adding more tracks
			addTrackButton.addEventListener('click', () => {
				addTrack();
			});

			const addTrack = (file) => {
				const newAudioBlock = document.createElement('ab-audio-block');
				audioBlocks.appendChild(newAudioBlock);

				playingSelect.addTrackOption(newAudioBlock);
				transitionSelect.addTrackOption(newAudioBlock);

				if (file) {
					newAudioBlock.loadFile(file);
				}
			};
		</script>
		<script>
			// wire playing and transition track select controls
			playingSelect.addEventListener('trigger-action', () => {
				playingSelect.selectedTrackBlock.play();
			});

			transitionSelect.addEventListener('trigger-action', () => {
				playingSelect.selectedTrackBlock?.fadeOut();
				transitionSelect.selectedTrackBlock?.fadeIn();

				// swap selected values
				playingSelect.setSelectedTrack(transitionSelect.selectedTrack.value);
			});
		</script>
	</body>
</html>
