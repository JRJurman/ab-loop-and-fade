<!DOCTYPE html>
<html lang="en">
	<head>
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link
			href="https://fonts.googleapis.com/css2?family=Kanit:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
			rel="stylesheet"
		/>

		<title>A-B Loop and Crossfade</title>
		<style>
			/* Kanit font - https://fonts.google.com/specimen/Kanit */
			:root {
				font-family: 'Kanit', sans-serif;
			}

			/* Unfretted Color Scheme - https://colors.lol/unfretted */
			:root {
				color: #ffd8b1;
				background: #610023;
				accent-color: #ffd8b1;
			}

			main {
				display: flex;
				flex-direction: column;
				width: 100%;
				gap: 1em;
			}

			h1 {
				font-weight: 400;
				border-bottom: solid 1px currentColor;
				margin: 0 0 0.5em 0;
				padding: 0.5em 0em;
				text-align: center;
			}

			fieldset {
				display: flex;
				flex-direction: column;
				gap: 0.25em;
				border-radius: 20px;
				border-color: currentColor;
				border-style: solid;
			}

			fieldset div {
				display: flex;
				gap: 1em;
				align-items: center;
			}
		</style>
	</head>
	<body>
		<main>
			<h1>A-B Loop And Crossfade</h1>
			<label>
				Master Volume
				<input id="masterVolume" type="range" min="0" max="100" step="1" value="100" />
				<output id="masterVolumeOutput">100</output>
			</label>
			<input id="file" type="file" accept="audio/*" />
			<fieldset>
				<legend>Tracks</legend>
				<div>
					<audio id="audio1" controls></audio>
					<label>
						<input id="track1Volume" type="range" min="0" max="1" step="any" value="1" disabled />
						<output id="track1VolumeOutput">1.000</output>
					</label>
				</div>
				<div>
					<audio id="audio2" controls></audio>
					<label>
						<input id="track2Volume" type="range" min="0" max="1" step="any" value="1" disabled />
						<output id="track2VolumeOutput">1.000</output>
					</label>
				</div>
			</fieldset>
			<fieldset>
				<legend>Controls</legend>
				<label>
					Point A
					<input id="pointA" type="range" min="0" max="100" step="1" value="10" />
					<output id="pointAOutput">0:10</output>
				</label>
				<label>
					Point B
					<input id="pointB" type="range" min="0" max="100" step="1" value="90" />
					<output id="pointBOutput">1:30</output>
				</label>
				<label>
					Passthrough
					<input id="passthrough" type="checkbox" />
				</label>
				<label>
					Crossfade
					<input id="crossfade" type="range" min="0" max="5000" step="100" value="1500" />
					<output id="crossfadeOutput">1500 ms</output>
				</label>
			</fieldset>
		</main>
		<script>
			const onPassthroughChange = () => {
				pointB.disabled = passthrough.checked;
			};
			passthrough.addEventListener('change', onPassthroughChange);
		</script>
		<script>
			const onMasterVolumeChange = () => {
				masterVolumeOutput.value = masterVolume.value;
				audio1.volume = masterVolume.value / 100;
				audio2.volume = masterVolume.value / 100;
			};
			masterVolume.addEventListener('input', onMasterVolumeChange);
		</script>
		<script>
			const onVolumeChange = (audioElement, trackInput, trackOutput) => {
				trackInput.value = audioElement.volume;
				trackOutput.value = audioElement.volume.toFixed(3);
			};
			audio1.addEventListener('volumechange', () => onVolumeChange(audio1, track1Volume, track1VolumeOutput));
			audio2.addEventListener('volumechange', () => onVolumeChange(audio2, track2Volume, track2VolumeOutput));
		</script>
		<script>
			const onUpdateRangeOutput = (rangeInput, rangeOutput) => {
				const rawSeconds = rangeInput.value % 60;
				const seconds = rawSeconds < 10 ? `0${rawSeconds}` : rawSeconds;
				const minutes = Math.floor(rangeInput.value / 60);
				rangeOutput.value = `${minutes}:${seconds}`;
			};
			pointA.addEventListener('input', () => onUpdateRangeOutput(pointA, pointAOutput));
			pointB.addEventListener('input', () => onUpdateRangeOutput(pointB, pointBOutput));
		</script>
		<script>
			const onUpdateCrossfade = () => {
				crossfadeOutput.value = `${crossfade.value} ms`;
			};
			crossfade.addEventListener('input', onUpdateCrossfade);
		</script>
		<script>
			const onUpdateMasterVolume = () => {
				masterVolumeOutput.value = masterVolume.value;
				masterVolume.addEventListener('input', onUpdateMasterVolume);
			};
		</script>
		<script>
			file.addEventListener('change', () => {
				const url = URL.createObjectURL(file.files[0]);
				audio1.src = url;
				audio2.src = url;
				audio1.onloadedmetadata = () => {
					const duration = audio1.duration || 100;
					pointA.max = duration;
					pointB.max = duration;
				};
			});
		</script>
		<script>
			const intervalMS = 10;
			const startCrossfade = (fromAudioElement, toAudioElement) => {
				// set data attributes (so we can style and determine which elements are which)
				fromAudioElement.setAttribute('data-crossfade', 'from');
				toAudioElement.setAttribute('data-crossfade', 'to');

				// setup our toAudioElement
				toAudioElement.volume = 0;
				toAudioElement.currentTime = pointA.value;
				toAudioElement.play();

				// fixed interval of 10 ms
				window.crossfadeIntervalId = setInterval(stepCrossfade, intervalMS);
			};

			const stepCrossfade = () => {
				const fromAudioElement = document.querySelector('[data-crossfade="from"]');
				const toAudioElement = document.querySelector('[data-crossfade="to"]');

				// if we've finished, clear the interval
				const masterVolumeAudioValue = masterVolume.value / 100;
				if (toAudioElement.volume >= masterVolumeAudioValue) {
					clearInterval(window.crossfadeIntervalId);
					fromAudioElement.pause();
					fromAudioElement.removeAttribute('data-crossfade');
					toAudioElement.removeAttribute('data-crossfade');
				}

				// change the volume based on our intervalMS and crossfade value
				const volumeIncrement = intervalMS / crossfade.value;
				fromAudioElement.volume = Math.max(fromAudioElement.volume - volumeIncrement, 0);
				toAudioElement.volume = Math.min(toAudioElement.volume + volumeIncrement, 1);
			};

			const onTimeUpdate = (audioElement, otherAudioElement) => {
				// if we're already crossfading, do nothing
				const fromAudioElement = document.querySelector('[data-crossfade="from"]');
				const toAudioElement = document.querySelector('[data-crossfade="to"]');
				if (fromAudioElement || toAudioElement) {
					return;
				}
				// if the element is paused, do nothing
				if (audioElement.paused) {
					return;
				}
				// if passthrough is enabled, do nothing
				if (passthrough.checked) {
					return;
				}
				// if we've hit the end (point B), start the other audio element
				if (audioElement.currentTime >= pointB.value) {
					startCrossfade(audioElement, otherAudioElement);
				}
			};

			audio1.addEventListener('timeupdate', () => onTimeUpdate(audio1, audio2));
			audio2.addEventListener('timeupdate', () => onTimeUpdate(audio2, audio1));
		</script>
	</body>
</html>
